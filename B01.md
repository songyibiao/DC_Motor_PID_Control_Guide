# 理论分析

位置闭环控制就是根据编码器的脉冲累加测量电机的位置信息，并与目标值进行比较，得到控制偏差，然后通过对偏差的比例、积分、微分进行控制，使偏差趋向于零的过程。



理论分析

根据位置式离散 PID 公式：


$$
PWM = K_p * e(k) + K_i *  \sum e(k) + K_d[e(k)-e(k-1)]
$$


其中，

* $$e(k) $$：本次偏差；
* $$e(k-1)$$：上一次的偏差；
* $$\sum e(k)$$：$$e(k)$$以及之前的偏差的累积和，k 为 1、2、3...；
* $$PWM$$：输出



## 控制流程图

位置环控制原理图如下图所示。



## C 语言实现

位置环 PID 控制 C 语言实现的代码如下：

```
int Position_PID(int Encoder,int Target)
{
	static float Bias,Pwm,Integral_bias,Last_Bias;
	Bias=Encoder-Target; //计算偏差
	Integral-bisa+=Bias; //求出偏差的积分
	Pwm=Position|_Kp*Bias+Position_Ki*Integral_bias+Position_Kd*(Bias-Last_Bias);
	Last_Bias=Bias; //保存上一次偏差
	return Pwm; //输出
}
```





